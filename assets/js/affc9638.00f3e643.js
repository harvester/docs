"use strict";(self.webpackChunkharvester_docs=self.webpackChunkharvester_docs||[]).push([[43340],{95938:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});n(67294);var a=n(3905);const r={sidebar_position:2,sidebar_label:"Upgrade from v1.3.2 to v1.4.0",title:"Upgrade from v1.3.2 to v1.4.0"},o=void 0,i={unversionedId:"upgrade/v1-3-2-to-v1-4-0",id:"upgrade/v1-3-2-to-v1-4-0",title:"Upgrade from v1.3.2 to v1.4.0",description:"General information",source:"@site/docs/upgrade/v1-3-2-to-v1-4-0.md",sourceDirName:"upgrade",slug:"/upgrade/v1-3-2-to-v1-4-0",permalink:"/v1.5/upgrade/v1-3-2-to-v1-4-0",draft:!1,editUrl:"https://github.com/harvester/docs/edit/main/docs/upgrade/v1-3-2-to-v1-4-0.md",tags:[],version:"current",lastUpdatedAt:1733305603,formattedLastUpdatedAt:"Dec 4, 2024",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Upgrade from v1.3.2 to v1.4.0",title:"Upgrade from v1.3.2 to v1.4.0"},sidebar:"api",previous:{title:"Upgrading Harvester",permalink:"/v1.5/upgrade/index"},next:{title:"Upgrade from v1.3.1 to v1.3.2",permalink:"/v1.5/upgrade/v1-3-1-to-v1-3-2"}},s={},l=[{value:"General information",id:"general-information",level:2},{value:"Known issues",id:"known-issues",level:2},{value:"1. A VM with a container disk can&#39;t be migrated which makes the upgrade stuck in pre-drain status",id:"1-a-vm-with-a-container-disk-cant-be-migrated-which-makes-the-upgrade-stuck-in-pre-drain-status",level:3},{value:"2. Upgrade stuck on waiting for Harvester bundle",id:"2-upgrade-stuck-on-waiting-for-harvester-bundle",level:3}],d={toc:l},c="wrapper";function u({components:e,...t}){return(0,a.kt)(c,{...d,...t,components:e,mdxType:"MDXLayout"},(0,a.kt)("head",null,(0,a.kt)("link",{rel:"canonical",href:"https://docs.harvesterhci.io/v1.4/upgrade/v1-3-2-to-v1-4-0"})),(0,a.kt)("h2",{id:"general-information"},"General information"),(0,a.kt)("p",null,"An ",(0,a.kt)("strong",{parentName:"p"},"Upgrade")," button appears on the ",(0,a.kt)("strong",{parentName:"p"},"Dashboard")," screen whenever a new Harvester version that you can upgrade to becomes available. For more information, see ",(0,a.kt)("a",{parentName:"p",href:"/v1.5/upgrade/index#start-an-upgrade"},"Start an upgrade"),"."),(0,a.kt)("p",null,"For air-gapped environments, see ",(0,a.kt)("a",{parentName:"p",href:"/v1.5/upgrade/index#prepare-an-air-gapped-upgrade"},"Prepare an air-gapped upgrade"),"."),(0,a.kt)("h2",{id:"known-issues"},"Known issues"),(0,a.kt)("hr",null),(0,a.kt)("h3",{id:"1-a-vm-with-a-container-disk-cant-be-migrated-which-makes-the-upgrade-stuck-in-pre-drain-status"},"1. A VM with a container disk can't be migrated which makes the upgrade stuck in pre-drain status"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Manually stop the VMs to continue the upgrade process.")),(0,a.kt)("p",null,"When upgrading from v1.3.2 to v1.4.0, the upgrade process may become stuck if a VM with a container disk cannot be migrated. There is some limitation of live migration."),(0,a.kt)("p",null,"For more information, see ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/harvester/harvester/issues/7005"},"Issue #7005"),"."),(0,a.kt)("hr",null),(0,a.kt)("h3",{id:"2-upgrade-stuck-on-waiting-for-harvester-bundle"},"2. Upgrade stuck on waiting for Harvester bundle"),(0,a.kt)("p",null,"When upgrading from v1.3.2 to v1.4.0, the upgrade process may become stuck on waiting for the Harvester bundle to become ready. This issue is caused by a race condition when the Fleet agent (",(0,a.kt)("inlineCode",{parentName:"p"},"fleet-agent"),") is redeployed."),(0,a.kt)("p",null,"The following error messages indicate that the issue exists."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'> kubectl get bundles -n fleet-local\nNAME                                          BUNDLEDEPLOYMENTS-READY   STATUS\nmcc-harvester                                 0/1                       ErrApplied(1) [Cluster fleet-local/local: encountered 2 deletion errors. First is: admission webhook "validator.harvesterhci.io" denied the request: Internal error occurred: no route match found for DELETE /v1, Kind=Secret harvester-system/sh.helm.release.v1.harvester.v2]\nmcc-harvester-crd                             0/1                       ErrApplied(1) [Cluster fleet-local/local: admission webhook "validator.harvesterhci.io" denied the request: Internal error occurred: no route match found for DELETE /v1, Kind=Secret harvester-system/sh.helm.release.v1.harvester-crd.v1]\n')),(0,a.kt)("p",null,"You can run the following script to fix the issue."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'#!/bin/bash\n\npatch_fleet_bundle() {\n  local bundleName=$1\n  local generation=$(kubectl get -n fleet-local bundle ${bundleName} -o jsonpath=\'{.spec.forceSyncGeneration}\')\n  local new_generation=$((generation+1))\n  patch_manifest="$(mktemp)"\n  cat > "$patch_manifest" <<EOF\n{\n  "spec": {\n    "forceSyncGeneration": $new_generation\n  }\n}\nEOF\n  echo "patch bundle to new generation: $new_generation"\n  kubectl patch -n fleet-local bundle ${bundleName}  --type=merge --patch-file $patch_manifest\n  rm -f $patch_manifest\n}\n\necho "removing harvester validating webhook"\nkubectl delete validatingwebhookconfiguration harvester-validator\n\nfor bundle in mcc-harvester-crd mcc-harvester\ndo\n  patch_fleet_bundle ${bundle}\ndone\n\necho "removing longhorn services"\nkubectl delete svc longhorn-engine-manager -n longhorn-system --ignore-not-found=true\nkubectl delete svc longhorn-replica-manager -n longhorn-system --ignore-not-found=true\n')),(0,a.kt)("hr",null))}u.isMDXComponent=!0}}]);